parameters:
  - name: ado_service_connection_aml_ws
    type: string
  - name: subscriptionId
    type: string
  - name: resource_group
    type: string
  - name: aml_workspace
    type: string

steps:
- task: AzureCLI@2
  displayName: Get latest dataset version
  name: get_dataset_version
  inputs:
    azureSubscription: $(ado_service_connection_aml_ws)
    scriptType: bash
    scriptLocation: inlineScript
    inlineScript: |
      set -e
      dataset_version=$(az ml data list --name train --resource-group ${{ parameters.resource_group }} --workspace-name ${{ parameters.aml_workspace }} --query "[].version" -o tsv | sort -n | tail -n 1)
      echo "Latest dataset version: $dataset_version"
      echo "##vso[task.setvariable variable=dataset_version]$dataset_version"

- task: AzureCLI@2
  displayName: Run RAI pipeline
  inputs:
    azureSubscription: $(ado_service_connection_aml_ws)
    scriptType: bash
    scriptLocation: inlineScript
    inlineScript: |
      set -e 
      python mlops/scripts/rai.py \
      --dataset_version $get_dataset_version.dataset_version
