parameters:
- name: experiment_name
  type: string
- name: compute_name
  type: string

steps:
- task: AzureCLI@2
  displayName: Get latest dataset version
  name: get_dataset_version
  inputs:
    azureSubscription: $(ado_service_connection_aml_ws)
    scriptType: bash
    scriptLocation: inlineScript
    inlineScript: |
      set -e
      dataset_version=$(az ml data list --name train --resource-group $(resource_group) --workspace-name $(workspace_name) --query "[].version" -o tsv | sort -n | tail -n 1)
      echo "Latest dataset version: $dataset_version"
      echo "##vso[task.setvariable variable=dataset_version]$dataset_version"

- task: AzureCLI@2
  displayName: Run RAI pipeline
  inputs:
    azureSubscription: $(ado_service_connection_aml_ws)
    scriptType: bash
    scriptLocation: inlineScript
    inlineScript: |
      set -e 
      python mlops/scripts/rai.py \
      --dataset_version $get_dataset_version.dataset_version
